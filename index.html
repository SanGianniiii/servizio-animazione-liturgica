<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1d4ed8">
    <title>Cantori - Calendario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js"></script>

    <style>
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-anim { animation: fadeInUp 0.4s ease-out forwards; }
        .details-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .details-open .details-content { max-height: 200px; }
        .details-open .arrow-icon { transform: rotate(180deg); }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans min-h-screen">

    <header class="bg-blue-700 text-white p-6 shadow-md sticky top-0 z-50">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold italic">Cantori Parrocchia</h1>
                <p class="text-blue-100 text-xs">Servizio Messe & Eventi</p>
            </div>
            <button onclick="richiediPermesso()" class="bg-blue-600 hover:bg-blue-500 p-3 rounded-xl shadow-lg transition-all active:scale-95 border border-blue-400/30">
                ðŸ”” <span class="text-xs ml-1 font-bold uppercase">Avvisami</span>
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">

        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
            <label class="block text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] mb-3">Chi sta visualizzando?</label>
            <div class="relative">
                <select id="filtroNome" onchange="filtraTurni()" 
                        class="w-full p-4 bg-gray-50 border border-gray-100 rounded-xl text-gray-800 font-bold focus:ring-2 focus:ring-blue-600 outline-none cursor-pointer appearance-none shadow-inner">
                    <option value="">âœ¨ Tutti i cantori</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-400">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
            </div>
        </div>

        <div id="container-lista">
            <h2 id="titolo-sezione" class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 px-2">Prossimi appuntamenti</h2>
            <div id="lista-turni" class="space-y-4">
                <div class="text-center py-10 text-gray-400">
                    <div class="animate-spin inline-block w-6 h-6 border-[3px] border-current border-t-transparent text-blue-600 rounded-full mb-2"></div>
                    <p class="text-xs font-medium italic">Aggiornamento calendario...</p>
                </div>
            </div>
        </div>

    </main>

    <script>
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSBN24W-OjHLzE_nGhR55i_Y56r03-lgM4VcjuvDkF7thIsOsBZiq3XqLPUWRG3Hnohil1fJPf3PH0U/pub?output=csv";
        
        let tuttiITurni = [];

        async function init() {
            try {
                const response = await fetch(SHEET_URL);
                const csvData = await response.text();
                const righe = csvData.split('\n').slice(1);
                let setNomi = new Set();

                tuttiITurni = righe.map(riga => {
                    const col = riga.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    
                    // Ordine: 0:Giorno, 1:Servizio, 2:Orario, 3:Cantori, 4:Note
                    const cantoriString = col[3] ? col[3].replace(/"/g, '').trim() : "";
                    cantoriString.split(';').forEach(n => { if(n.trim()) setNomi.add(n.trim()); });

                    return {
                        giorno: col[0] ? col[0].trim() : "",
                        servizio: col[1] ? col[1].trim() : "",
                        orario: col[2] ? col[2].trim() : "",
                        cantori: cantoriString.replace(/;/g, ', '),
                        note: col[4] ? col[4].replace(/"/g, '').trim() : ""
                    };
                }).filter(t => t.giorno !== "");

                popolaSelect(Array.from(setNomi).sort());
                renderizza(tuttiITurni);
            } catch (err) {
                document.getElementById('lista-turni').innerHTML = `<p class="text-center text-red-500 text-xs italic">Errore caricamento dati.</p>`;
            }
        }

        function popolaSelect(nomi) {
            const select = document.getElementById('filtroNome');
            nomi.forEach(nome => {
                const opt = document.createElement('option');
                opt.value = nome.toLowerCase();
                opt.textContent = nome;
                select.appendChild(opt);
            });
        }

        function toggleDetails(element) {
            element.classList.toggle('details-open');
        }

        function renderizza(lista) {
            const container = document.getElementById('lista-turni');
            if(lista.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-400 py-10">Nessun servizio trovato.</p>`;
                return;
            }

            container.innerHTML = lista.map(t => `
                <div onclick="toggleDetails(this)" class="card-anim bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden cursor-pointer transition-all active:scale-[0.98]">
                    <div class="p-5 flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="bg-blue-50 text-blue-700 p-2 rounded-xl text-center min-w-[65px] border border-blue-100">
                                <span class="block text-[10px] font-black uppercase leading-none mb-1">${t.giorno}</span>
                                <span class="block text-sm font-black">${t.orario}</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800 text-base leading-tight">${t.servizio}</h3>
                                <p class="text-blue-600 text-[11px] font-bold mt-1 uppercase tracking-tighter">Tocca per dettagli</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-300 arrow-icon transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    
                    <div class="details-content bg-gray-50 border-t border-gray-100">
                        <div class="p-5 space-y-3">
                            <div>
                                <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Cantori assegnati</span>
                                <p class="text-sm text-gray-700 font-medium">${t.cantori || 'Da definire'}</p>
                            </div>
                            ${t.note ? `
                            <div>
                                <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Note servizio</span>
                                <p class="text-sm text-gray-600 italic leading-relaxed">${t.note}</p>
                            </div>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filtraTurni() {
            const scelto = document.getElementById('filtroNome').value;
            const titolo = document.getElementById('titolo-sezione');
            if (!scelto) {
                titolo.textContent = "Prossimi appuntamenti";
                renderizza(tuttiITurni);
            } else {
                titolo.textContent = `Servizi di: ${scelto}`;
                const filtrati = tuttiITurni.filter(t => t.cantori.toLowerCase().includes(scelto));
                renderizza(filtrati);
            }
        }

        init();
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
    </script>
</body>
</html>
