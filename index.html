<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <title>Calendario Cantori</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Animazione caricamento card */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-enter { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        /* Logica a soffietto per le note */
        .details-content { max-height: 0; opacity: 0; overflow: hidden; transition: all 0.4s ease; }
        .details-open .details-content { max-height: 300px; opacity: 1; margin-top: 1rem; }
        .details-open .arrow-icon { transform: rotate(180deg); }
        .details-open { background-color: #f8fafc; } /* Grigio chiarissimo quando aperto */
    </style>
</head>
<body class="bg-gray-100 text-slate-800 min-h-screen pb-10">

    <header class="bg-gradient-to-r from-blue-900 to-blue-700 text-white p-5 shadow-lg sticky top-0 z-50">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black tracking-tight">Cantori</h1>
                <p class="text-blue-200 text-[10px] font-bold uppercase tracking-widest mt-0.5">Calendario Liturgico</p>
            </div>
            <button onclick="richiediPermesso()" class="bg-white/10 hover:bg-white/20 backdrop-blur-sm border border-white/20 p-2 rounded-xl transition-all active:scale-95 flex items-center justify-center group">
                <span class="text-xl group-hover:rotate-12 transition-transform">üîî</span>
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4 pt-4 space-y-6">

        <div class="bg-white p-2 rounded-xl shadow-sm border border-blue-100 flex items-center">
            <div class="pl-4 pr-3 text-blue-500">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <select id="filtroNome" onchange="filtraTurni()" 
                    class="w-full p-3 bg-transparent text-slate-700 font-bold outline-none cursor-pointer appearance-none text-sm">
                <option value="">Filtra servizi per cantore</option>
            </select>
        </div>

        <div id="container-lista">
            <div class="flex items-center justify-between mb-4 px-2">
                <h2 id="titolo-sezione" class="text-xs font-bold text-slate-400 uppercase tracking-widest">In Programma</h2>
            </div>
            
            <div id="lista-turni" class="space-y-4">
                <div class="flex flex-col items-center justify-center py-12 text-slate-400 space-y-3">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span class="text-xs font-medium">Sincronizzazione in corso...</span>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- CONFIGURAZIONE ---
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSBN24W-OjHLzE_nGhR55i_Y56r03-lgM4VcjuvDkF7thIsOsBZiq3XqLPUWRG3Hnohil1fJPf3PH0U/pub?output=csv";
        
        // Inserisci qui i tuoi dati presi da Firebase Console
        const firebaseConfig = {
    apiKey: "AIzaSyAIB56h4OiO79B1AXMiG75C_EchLcI7S5s",
    authDomain: "cantoriapp-e18b1.firebaseapp.com",
    projectId: "cantoriapp-e18b1",
    storageBucket: "cantoriapp-e18b1.firebasestorage.app",
    messagingSenderId: "21232278125",
    appId: "1:21232278125:web:6b82fed0650b385a717d64",
    measurementId: "G-5CDCBR02FM"
  };
        // ----------------------

        let tuttiITurni = [];
        firebase.initializeApp(firebaseConfig);
        const messaging = ('serviceWorker' in navigator && 'PushManager' in window) ? firebase.messaging() : null;

        async function init() {
            try {
                const response = await fetch(SHEET_URL);
                const csvData = await response.text();
                const righe = csvData.split('\n').slice(1);
                
                let setNomi = new Set();
                const oggi = new Date();
                oggi.setHours(0, 0, 0, 0); // Reset orario per confronto corretto

                tuttiITurni = righe.map(riga => {
                    // Regex per gestire virgole dentro le virgolette
                    const col = riga.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if(col.length < 3) return null;

                    const dataStr = col[0] ? col[0].trim() : "";
                    
                    // -- GESTIONE DATA --
                    // Supporta formato 15/02 o 15/02/2026
                    const parti = dataStr.split('/');
                    if (parti.length < 2) return null;
                    const anno = parti[2] ? parti[2] : new Date().getFullYear();
                    const dataEvento = new Date(anno, parti[1] - 1, parti[0]);

                    // 1. Filtro Passato: Se la data √® ieri o prima, nascondi
                    if (dataEvento < oggi) return null;

                    // 2. Formattazione Elegante: "Marted√¨ 10 Febbraio 2026"
                    const opzioniData = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
                    let dataFormattata = dataEvento.toLocaleDateString('it-IT', opzioniData);
                    // Mette la maiuscola alla prima lettera
                    dataFormattata = dataFormattata.charAt(0).toUpperCase() + dataFormattata.slice(1);

                    // -- GESTIONE CANTORI --
                    const cantoriStr = col[3] ? col[3].replace(/"/g, '').trim() : "";
                    cantoriStr.split(';').forEach(n => { if(n.trim()) setNomi.add(n.trim()); });

                    return {
                        giorno: dataFormattata,
                        giornoShort: `${parti[0]}/${parti[1]}`, // Per backup visivo
                        servizio: col[1] ? col[1].trim() : "Servizio",
                        orario: col[2] ? col[2].trim() : "",
                        cantori: cantoriStr.replace(/;/g, ', '),
                        note: col[4] ? col[4].replace(/"/g, '').trim() : ""
                    };
                }).filter(t => t !== null);

                popolaSelect(Array.from(setNomi).sort());
                renderizza(tuttiITurni);
            } catch (err) {
                console.error(err);
                document.getElementById('lista-turni').innerHTML = 
                    `<div class="bg-red-50 text-red-600 p-4 rounded-xl text-center text-sm">Impossibile caricare i dati. Controlla la connessione.</div>`;
            }
        }

        function popolaSelect(nomi) {
            const select = document.getElementById('filtroNome');
            nomi.forEach(nome => {
                const opt = document.createElement('option');
                opt.value = nome.toLowerCase();
                opt.textContent = nome;
                select.appendChild(opt);
            });
        }

        function toggleDetails(element) {
            if (element.classList.contains('has-note')) {
                element.classList.toggle('details-open');
            }
        }

        function renderizza(lista) {
            const container = document.getElementById('lista-turni');
            if(lista.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-400 py-10 text-sm font-medium bg-white rounded-2xl shadow-sm border border-gray-100">Nessun impegno futuro trovato.</div>`;
                return;
            }

            container.innerHTML = lista.map((t, index) => `
                <div onclick="toggleDetails(this)" 
                     class="card-enter bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden transition-all duration-300 hover:shadow-md ${t.note ? 'cursor-pointer active:scale-[0.99] has-note group' : ''}" 
                     style="animation-delay: ${index * 50}ms">
                    
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center space-x-2 text-blue-800">
                                <span class="bg-blue-100 text-blue-700 p-1.5 rounded-lg">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                </span>
                                <span class="font-bold text-sm uppercase tracking-wide">${t.giorno}</span>
                            </div>
                            ${t.orario ? `
                            <div class="bg-slate-800 text-white px-3 py-1 rounded-full text-xs font-bold tracking-wide shadow-sm flex items-center">
                                ${t.orario}
                            </div>` : ''}
                        </div>

                        <div class="pl-1">
                            <h3 class="text-xl font-black text-slate-800 leading-tight mb-2">${t.servizio}</h3>
                            
                            <div class="flex items-start text-slate-600 text-sm font-medium">
                                <span class="mr-2 mt-0.5 text-blue-500">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                </span>
                                <span class="leading-relaxed">${t.cantori || 'Nessun cantore assegnato'}</span>
                            </div>
                        </div>

                        ${t.note ? `
                        <div class="mt-4 flex justify-between items-center border-t border-gray-50 pt-3">
                            <span class="text-[10px] font-bold text-blue-500 uppercase tracking-widest flex items-center">
                                <span class="w-1.5 h-1.5 bg-blue-500 rounded-full mr-2 animate-pulse"></span>
                                Note disponibili
                            </span>
                            <svg class="w-5 h-5 text-gray-300 arrow-icon transition-transform duration-300 group-hover:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        ` : ''}
                    </div>

                    ${t.note ? `
                    <div class="details-content">
                        <div class="px-5 pb-5">
                            <div class="bg-amber-50 border border-amber-100 rounded-xl p-4 flex items-start space-x-3">
                                <span class="text-amber-500 mt-0.5 text-lg">‚ö†Ô∏è</span>
                                <div>
                                    <p class="text-[10px] font-bold text-amber-600 uppercase tracking-widest mb-1">Dettagli & Istruzioni</p>
                                    <p class="text-sm text-slate-700 leading-relaxed">${t.note}</p>
                                </div>
                            </div>
                        </div>
                    </div>` : ''}
                </div>
            `).join('');
        }

        function filtraTurni() {
            const scelto = document.getElementById('filtroNome').value;
            const titolo = document.getElementById('titolo-sezione');
            
            if (!scelto) {
                titolo.textContent = "In Programma";
                renderizza(tuttiITurni);
            } else {
                titolo.textContent = `Turni di: ${scelto}`; // La maiuscola √® gestita dal CSS
                // Filtro case-insensitive
                const filtrati = tuttiITurni.filter(t => t.cantori.toLowerCase().includes(scelto));
                renderizza(filtrati);
            }
        }

        function richiediPermesso() {
    if (!messaging) return alert("Notifiche non supportate dal browser.");

    // 1. Chiediamo subito il nome al cantore
    const nomeCantore = prompt("Inserisci il tuo Nome e Cognome (es. Mario Rossi):");
    
    if (!nomeCantore || nomeCantore.trim() === "") {
        alert("Il nome √® necessario per associare le notifiche al tuo turno.");
        return;
    }

    Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
            // 2. Recuperiamo il Token da Firebase
            messaging.getToken({ 
                vapidKey: 'BFZrSR_2DQTR8QZYhsgG1nywKv9H_HaHphBL-qeOb9caRnrgJNJjyoWMccZMbPbF1gt5VLL8KuhxgKo-x4OzT6w' 
            })
            .then(token => {
                // 3. MANDIAMO I DATI AL TUO GOOGLE SHEET
                // Sostituisci l'URL qui sotto con quello della tua WEB APP (copiato da Apps Script)
                const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyACPqBqb9VYqkxuelZT2tQxmplMcIvjXlXEQDQljcqh1kOj6AlVBjG5M_Ckar4SMtRiw/exec";

                fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Necessario per comunicare con Google Script
                    body: JSON.stringify({ 
                        nome: nomeCantore, 
                        token: token 
                    })
                });

                alert("Ottimo " + nomeCantore + "! Notifiche attivate e collegate al foglio turni.");
                console.log("Token inviato:", token);
            })
            .catch(err => {
                console.error("Errore recupero token:", err);
                alert("Errore durante l'attivazione. Riprova.");
            });
        } else {
            alert("Hai negato il permesso per le notifiche.");
        }
    });
}

        init();
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>





